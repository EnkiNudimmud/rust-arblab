# Unified docker-compose for HFT Arbitrage Lab with optimized caching
services:
  # Mock APIs for testing
  mock_apis:
    build: 
      context: .
      dockerfile: mock_apis/Dockerfile
    image: rust-hft-lab:mock-apis-latest
    container_name: mock_apis
    ports:
      - "8000:8000"
    volumes:
      - ./mock_apis/data:/data:ro

  # gRPC Server for ultra-fast pair discovery backend
  grpc-server:
    build:
      context: ..
      dockerfile: rust-arblab/Dockerfile
      target: runtime
    image: rust-hft-lab:latest
    container_name: hft-grpc-server
    ports:
      - "50051:50051"  # gRPC
    volumes:
      - ./data:/app/data
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/workspace/target
    working_dir: /app
    environment:
      - RUST_LOG=info
      - GRPC_BIND_ADDRESS=0.0.0.0:50051
    command: ["./target/release/hft-server"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "50051"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Main lab environment
  lab:
    build:
      context: ..
      dockerfile: rust-arblab/Dockerfile
      target: runtime
    image: rust-hft-lab:latest
    container_name: hft-lab
    ports:
      - "8501:8501"  # Streamlit
      - "8888:8888"  # Jupyter
    volumes:
      - ./app:/app/app
      - ./python:/app/python
      - ./scripts:/app/scripts
      - ./api_keys.properties:/app/api_keys.properties:ro
      - hft_data:/app/data
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/workspace/target
    environment:
      - PYTHONPATH=/app
      - BACKEND_TYPE=grpc
      - GRPC_HOST=grpc-server
      - GRPC_PORT=50051
      - STREAMLIT_SERVER_FILE_WATCHER_TYPE=poll
    command: ["streamlit", "run", "app/HFT_Arbitrage_Lab.py", "--server.address=0.0.0.0"]
    depends_on:
      - mock_apis
      - grpc-server
    restart: unless-stopped

  # Jupyter notebook server with optimizr and gRPC client
  jupyter:
    build:
      context: ..
      dockerfile: rust-arblab/Dockerfile
      target: runtime
    image: rust-hft-lab:latest
    container_name: hft-jupyter
    ports:
      - "8889:8888"
    volumes:
      - ./app:/app/app:ro
      - ./python:/app/python:ro
      - ./examples:/app/examples
      - ./scripts:/app/scripts:ro
      - ./api_keys.properties:/app/api_keys.properties:ro
      - hft_data:/app/data
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/workspace/target
    environment:
      - PYTHONPATH=/app
      - GRPC_HOST=grpc-server
      - GRPC_PORT=50051
      - RUST_LOG=info
    command: ["bash", "scripts/start_jupyter.sh"]
    depends_on:
      grpc-server:
        condition: service_healthy
      mock_apis:
        condition: service_started

volumes:
  hft_data:
    driver: local
  cargo-cache:
    driver: local
  target-cache:
    driver: local
